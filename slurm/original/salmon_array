#!/bin/bash
#SBATCH --job-name=salmon_R570
#SBATCH --array=1-24                  # Array range: tasks 1 to 24
#SBATCH --cpus-per-task=32            # Threads per task
#SBATCH --mem=50G                     # Memory per task
#SBATCH --time=04:00:00               # Max runtime per task
#SBATCH --output=sal_quant_%A_%a.out  # Stdout: %A=jobID, %a=arrayID
#SBATCH --error=sal_quant_%A_%a.err   # Stderr: %A=jobID, %a=arrayID
#SBATCH --partition=general           # Optional: specify partition if needed
#SBATCH --account=a_nefzger

# Load Salmon module
module load salmon

# Define directory paths
BASE_DIR="/QRISdata/Q9062"
READS_DIR="${BASE_DIR}/05_smut/clean"
OUT_DIR="${BASE_DIR}/07_salmon_R570/quants"
INDEX_DIR="${BASE_DIR}/06_ref/R570_salmon_index"
SAMPLE_LIST="${BASE_DIR}/08_deseq2/samples.txt"

# Create output directory if it doesn't exist
mkdir -p "$OUT_DIR"

# Retrieve the sample name corresponding to the current Array Task ID
# 'sed' pulls the specific line number from the sample list file
SAMPLE=$(sed -n "${SLURM_ARRAY_TASK_ID}p" "$SAMPLE_LIST")

# Validate that a sample name was retrieved
if [ -z "$SAMPLE" ]; then
    echo "Error: No sample name found for Task ID ${SLURM_ARRAY_TASK_ID}"
    exit 1
fi

echo "Starting processing for Sample ID: $SAMPLE (Array Task: ${SLURM_ARRAY_TASK_ID})"

# Run Salmon quantification
salmon quant \
    -i "$INDEX_DIR" \
    -l A \
    -1 "$READS_DIR/${SAMPLE}_R1.fastq.gz" \
    -2 "$READS_DIR/${SAMPLE}_R2.fastq.gz" \
    -p ${SLURM_CPUS_PER_TASK} \
    --validateMappings \
    -o "$OUT_DIR/$SAMPLE"

echo "Finished processing $SAMPLE"
